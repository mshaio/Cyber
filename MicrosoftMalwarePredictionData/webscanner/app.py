from network_scan import NetworkScanner
from network_scan import get_local_ip

#Global variable
global temp_ip_list
temp_ip_list = []
global old_ip_list
old_ip_list = []

#Web framework imports
from flask import Flask, render_template

local_scanner = NetworkScanner(get_local_ip())

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/about')
def about():
    #10.115.201.188
    #ip = get_domain_name_ip("usedvictoria.com")
    #nmap_output = get_nmap("-F",ip)
    #threading.Timer(20.0,about).start()
    arp_output = local_scanner.get_devices_on_network("-sn", "-a -n")
    ips = local_scanner.format_to_get_ip(arp_output)[:-2]
    macs = local_scanner.format_to_get_mac(arp_output)[:-2]
    vendors = local_scanner.get_vendor_by_mac(macs)
    # vendors = get_vendor_by_mac(macs)
    number_of_devices = createList(0,len(macs)-1)
    open_ports = 'close'#get_open_port_details(ips)

    #scenario 1:
    #newips = [1,2,3,4,5] oldips = [1,2,3]
    #scenario 2:
    #newips = [1,2,3,4,6] oldips = [1,2,3,4,7]
    #scenario 3:
    #newips = [1,2] oldips = [1,2,3,4,5]
    #newips = [1,7] oldips = [1,2,3,4,5]


    global temp_ip_list
    print('temp_ip_list',temp_ip_list)
    global old_ip_list
    if (set(old_ip_list) != set(ips)):
        identical_ips = False
        temp_ip_list = list(set(ips).difference(old_ip_list))
        old_ip_list = ips
    else:
        identical_ips = True
        temp_ip_list = ips
    return render_template('about.html', number_of_devices = number_of_devices, ips = ips, macs = macs, vendors = vendors, open_ports = open_ports, identical_ips = identical_ips, temp_ip_list = temp_ip_list)

def createList(r1, r2):
    return [item for item in range(r1, r2+1)]
# def get_domain_name_ip(url):
#     ip = socket.gethostbyname(url)
#     return ip

# def banner_grabber():
#     s = socket.socket()
#     ip = "10.0.0.1"
#     port = str(22)
#     s.connect((ip,int(port)))
#     print(s.recv(1024))

# def virus_total_scan():
#     url = 'https://www.virustotal.com/vtapi/v2/ip-address/report'
#     params = {'apikey':'ce73360a9d0367f3bffdb01774fcddf28c02366ad05c812cff2ac6e09377aa3b','ip':'104.219.54.206'}
#     response = requests.get(url, params=params)
#     print(response.json())
#     return

# def hello_world():
#     #threading.Timer(2.0, hello_world).start() # called every minute
#     print("Hello, World!")

# def malware_analysis():
#     data = pd.read_csv("/Users/markshaio/Desktop/Personal Projects/Cyber/MicrosoftMalwarePredictionData/train.csv")
#     df = data[['ProductName','EngineVersion','AppVersion','DefaultBrowsersIdentifier','AVProductStatesIdentifier','HasTpm','CountryIdentifier','Platform','Processor','OsVer','OsBuild','IsProtected','SMode','Firewall','Census_PrimaryDiskTotalCapacity','Census_IsVirtualDevice','Wdft_IsGamer']]
#     print(df.head())

if __name__ == "__main__":
    app.run(debug=False)
