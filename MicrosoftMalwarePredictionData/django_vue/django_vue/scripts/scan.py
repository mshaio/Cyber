import schedule
import time
from devices.models import Device
from lib import network_scan

def scan():
    """
    Scan the network

    Args:
        None
    Returns:
        None
    """
    print("SCAN")
    local_scanner = network_scan.NetworkScanner(network_scan.get_local_ip())
    arp_output = local_scanner.get_devices_on_network("-sn", "-a -n")
    ips = local_scanner.format_to_get_ip(arp_output)[:-2]
    macs = local_scanner.format_to_get_mac(arp_output)[:-2]
    vendors = local_scanner.get_vendor_by_mac(macs)
    mobile, iphone, android = network_scan.NetworkScanner.detect_mobile(ips)
    print(arp_output)
    print(ips)
    print(macs)
    print(vendors)

    for i in range(len(ips)):
        device = Device()
        device.ip_address = ips[i]
        device.mac_address = macs[i]
        device.vendor = vendors[i]
        device.mobile = mobile[i]
        device.port = 22
        device, created = Device.objects.update_or_create(ip_address=device.ip_address,mac_address=device.mac_address,vendor=device.vendor,mobile=device.mobile,port=device.port)

def run():
    """
    Calls the scan() function. Using the django-extension runscript. 
    Helpful blog post: http://blog.brendel.com/2012/01/how-to-use-djangextensions-runscript.html
    """
    return scan()

"""
Runs the scan function every 5 seconds
"""
schedule.every(5).seconds.do(scan)
while True:
    schedule.run_pending()
    time.sleep(1)