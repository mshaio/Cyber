<template>
    <div>
        <NavBar></NavBar>
        <GChart
            type="Sankey"
            :data="chartData"
            :options="options"
          />
          <GChart
            type="LineChart"
            :data="systemData"
            :options="chartOptions"
          />
    </div>
</template>

<script>
import { GChart } from 'vue-google-charts'
import NavBar from '@/components/NavBar'

export default {
    name: 'Dashboard',
    components: {
        NavBar,
        GChart
    },
    data() {
        return {
            devices: [],
            system: [],
            api_url: 'http://127.0.0.1:8000/networks/devices/',
            system_api_url: 'http://127.0.0.1:8000/networks/systems/',
            chartData: [
            [ 'string', 'string', 'number' ],
            ],
            systemData: [
                ['ID','CPU%','CPULoad'],
                // ['Year', 'Sales', 'Expenses'],
                // ['2004',  1000,      400],
                // ['2005',  1170,      460],
                // ['2006',  660,       1120],
                // ['2007',  1030,      540]
            ],
            colors: ['#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f','#cab2d6', '#ffff99', '#1f78b4', '#33a02c'],
            options: {
                height: 500,
                sankey: {
                node: {
                    colors: this.colors
                },
                link: {
                    colorMode: 'gradient',
                    colors: this.colors
                }
                }
            },
            chartOptions: {
                chart: {
                title: 'Local Network Status',
                subtitle: 'IP, Vendor, Ports Statuses',
                }
            }
        }
    },
    mounted () {
        /**
        * During the mounted life cycle hook perform an api get request to retrieve the devices data
        */
        const axios = require('axios')
        this.interval = setInterval(() => {
            // this.old_devices = this.devices
            axios.get(this.api_url).then((response) => {
                this.devices = response.data
                this.updateChartData()
                // this.updateSystemData()
                // this.detectNewDeviceOnNetwork()
            });
        }, 5000);
        axios.get(this.system_api_url).then((response) => {
            console.log(response)
            this.system = response.data
            this.updateSystemData()
        })
    },
    methods: {
        updateChartData: function() {
            /**
             * Gets called to update the chartData from the devices list 
             */
            if (this.chartData.length <= this.devices.length) {
                for (var i =0; i < this.devices.length; i++) {
                    this.chartData.push([this.devices[i].ip_address, this.devices[i].vendor, 1])
                    this.chartData.push([this.devices[i].vendor, this.devices[i].port, 1])
                }
            }
        },
        updateSystemData: function() {
            /**
             * Updates the system data to display on line chart. Still need to make it accept
             * lives changes and set the axios to routinely query the api
             */
            // if (this.system.length <= this.systemData.length) {
                for (var i = 0; i < this.systemData.length; i++) {
                    this.systemData.push([this.system[i].id,parseFloat(this.system[i].cpu_percent),parseFloat(this.system[i].cpu_avg_load)])
                }
            // }
            console.log(this.systemData)
        }
    }
}
</script>

<style lang="css" scoped>

</style>